<!doctype html><html lang=en-us><head><title>Writing a Debugger From Scratch - DbgRs Part 2 - Register State and Stepping // TimDbg</title>
<link rel="shortcut icon" href=WinDbg.ico><meta charset=utf-8><meta name=generator content="Hugo 0.121.2"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Tim Misiak"><meta name=description content><link rel=stylesheet href=/css/main.min.4a7ec8660f9a44b08c4da97c5f2e31b1192df1d4d0322e65c0dbbc6ecb1b863f.css><link rel=stylesheet href=/custom.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-ZF3NN3CLRX"></script><script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-ZF3NN3CLRX",{anonymize_ip:!1})}</script><meta name=twitter:card content="summary"><meta name=twitter:title content="Writing a Debugger From Scratch - DbgRs Part 2 - Register State and Stepping"><meta name=twitter:description content="When we left off last time, we had a basic &ldquo;debugger&rdquo; that could launch a Windows process and monitor events that occur in that process, but it&rsquo;s not yet something that you would really call a debugger. Two things that are missing are the ability to examine the state of the process and to control its execution. So that&rsquo;s what we&rsquo;re going to build next.
The code for this part is on GitHub as the part2 branch."><meta property="og:title" content="Writing a Debugger From Scratch - DbgRs Part 2 - Register State and Stepping"><meta property="og:description" content="When we left off last time, we had a basic &ldquo;debugger&rdquo; that could launch a Windows process and monitor events that occur in that process, but it&rsquo;s not yet something that you would really call a debugger. Two things that are missing are the ability to examine the state of the process and to control its execution. So that&rsquo;s what we&rsquo;re going to build next.
The code for this part is on GitHub as the part2 branch."><meta property="og:type" content="article"><meta property="og:url" content="/posts/writing-a-debugger-from-scratch-part-2/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-06T08:44:39-08:00"><meta property="article:modified_time" content="2023-03-06T08:44:39-08:00"><link rel=alternate type=application/rss+xml href=/index.xml title=TimDbg></head><body><header class=app-header><a href=/><img class=app-header-avatar src=/avatar.jpg alt="Tim Misiak"></a><h1>TimDbg</h1><nav class=app-header-menu><a class=app-header-menu-item href=/about/>About</a>
-
<a class=app-header-menu-item href=/tags/>Tags</a></nav><p>The art and science of debugging. And other stuff like that. From a former developer on WinDbg and the VMware hypervisor.</p><div class=app-header-social><a href=https://github.com/timmisiak target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>Github</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://twitter.com/timmisiak target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter"><title>Twitter</title><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a href=https://www.youtube.com/channel/UCyQ7p63-9V9PZJvgHLKgsaw target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-youtube"><title>YouTube</title><path d="M22.54 6.42a2.78 2.78.0 00-1.94-2C18.88 4 12 4 12 4s-6.88.0-8.6.46a2.78 2.78.0 00-1.94 2A29 29 0 001 11.75a29 29 0 00.46 5.33A2.78 2.78.0 003.4 19c1.72.46 8.6.46 8.6.46s6.88.0 8.6-.46a2.78 2.78.0 001.94-2 29 29 0 00.46-5.25 29 29 0 00-.46-5.33z"/><polygon points="9.75 15.02 15.5 11.75 9.75 8.48 9.75 15.02"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>Writing a Debugger From Scratch - DbgRs Part 2 - Register State and Stepping</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Mar 6, 2023</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>9 min read</div></div></header><div class=post-content><p>When we left off <a href=/posts/writing-a-debugger-from-scratch-part-1>last time</a>, we had a basic &ldquo;debugger&rdquo; that could launch a Windows process and monitor events that occur in that process, but it&rsquo;s not yet something that you would <em>really</em> call a debugger. Two things that are missing are the ability to examine the state of the process and to control its execution. So that&rsquo;s what we&rsquo;re going to build next.</p><p>The code for this part is on GitHub as the <a href=https://github.com/TimMisiak/dbgrs/tree/part2>part2 branch</a>. If you see any mistakes or ways to improve the code, feel free to <a href=https://github.com/TimMisiak/dbgrs/issues>create issues</a> in the GitHub repo or submit a PR. I&rsquo;ve had a few folks contribute issues and PRs, which I really appreciate!</p><h1 id=parsing-commands>Parsing commands</h1><p>In order to interact with a debugger, we need some sort of user interface. To keep things simple, we&rsquo;ll create a console interface that will use some of the same command names as ntsd. To do that, we&rsquo;ll need some basic string parsing. The commands we&rsquo;re starting with are going to be very simple without any arguments or parameters, but in a future part we&rsquo;ll be adding more complicated commands. To get a head start on that, we&rsquo;ll use <a href=https://github.com/hydro-project/rust-sitter>Rust Sitter</a>, which seems like a nice simple way to write a parser.</p><p>We&rsquo;ll start with four basic commands to implement: &ldquo;step into&rdquo;, &ldquo;go&rdquo;, &ldquo;display registers&rdquo;, and &ldquo;quit&rdquo;. These are some of the most basic commands that we can implement that do not require any interpretation of the state within the target process, and can be implemented purely in terms of reading and writing to the register context.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#75715e>#[rust_sitter::grammar(</span><span style=color:#e6db74>&#34;command&#34;</span><span style=color:#75715e>)]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>mod</span> grammar {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    <span style=color:#75715e>#[rust_sitter::language]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>enum</span> <span style=color:#a6e22e>Expr</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>        StepInto(<span style=color:#75715e>#[rust_sitter::leaf(text = </span><span style=color:#e6db74>&#34;t&#34;</span><span style=color:#75715e>)]</span> ()),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        Go(<span style=color:#75715e>#[rust_sitter::leaf(text = </span><span style=color:#e6db74>&#34;g&#34;</span><span style=color:#75715e>)]</span> ()),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        DisplayRegisters(<span style=color:#75715e>#[rust_sitter::leaf(text = </span><span style=color:#e6db74>&#34;r&#34;</span><span style=color:#75715e>)]</span> ()),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>        Quit(<span style=color:#75715e>#[rust_sitter::leaf(text = </span><span style=color:#e6db74>&#34;q&#34;</span><span style=color:#75715e>)]</span> ()),
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>}
</span></span></code></pre></div><p><small><a href=https://github.com/TimMisiak/dbgrs/blob/part2/src/command.rs>command.rs</a></small></p><p>We&rsquo;ll read input from stdin and attempt to parse it. If we fail to parse the input, we&rsquo;ll display the error and ask the user for input again. I&rsquo;ve omitted some parts because the focus is not the error handling, but you can see the full code in command.rs in the GitHub repo.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68</span><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>read_command</span>() -&gt; <span style=color:#a6e22e>grammar</span>::Expr {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69</span><span>    <span style=color:#66d9ef>let</span> stdin <span style=color:#f92672>=</span> std::io::stdin();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70</span><span>    <span style=color:#66d9ef>loop</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71</span><span>        print!(<span style=color:#e6db74>&#34;&gt; &#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72</span><span>        std::io::stdout().flush().unwrap();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73</span><span>        <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> input <span style=color:#f92672>=</span> String::new();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74</span><span>        stdin.read_line(<span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> input).unwrap();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75</span><span>        <span style=color:#66d9ef>let</span> input <span style=color:#f92672>=</span> input.trim().to_string();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76</span><span>        <span style=color:#66d9ef>if</span> <span style=color:#f92672>!</span>input.is_empty() {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77</span><span>            <span style=color:#66d9ef>let</span> cmd <span style=color:#f92672>=</span> grammar::parse(<span style=color:#f92672>&amp;</span>input);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78</span><span>            <span style=color:#66d9ef>match</span> cmd {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79</span><span>                Ok(c) <span style=color:#f92672>=&gt;</span> <span style=color:#66d9ef>return</span> c,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80</span><span>                Err(errs) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81</span><span>                    <span style=color:#75715e>// Omitted for brevity
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82</span><span><span style=color:#75715e></span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83</span><span>            }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84</span><span>        }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">85</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">86</span><span>}
</span></span></code></pre></div><p><small><a href=https://github.com/TimMisiak/dbgrs/blob/part2/src/command.rs>command.rs</a></small></p><h1 id=reading-the-registers>Reading the registers</h1><p>Now we have a way of reading commands from a user but we still need to retrieve the relevant information so we can display it. The commands we&rsquo;re implementing this time all revolve around the register context. Each thread has its own set of registers, so the API for reading the registers is called <a href=https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-getthreadcontext>GetThreadContext</a>. Note that what goes in a &ldquo;context&rdquo; can get very complex, especially when working with things like the AVX registers or other context extensions. We&rsquo;ll skip most of that for now, but if you want to read more about it you can consult the <a href=https://learn.microsoft.com/en-us/windows/win32/debug/working-with-xstate-context>documentation on XState</a>.</p><p>The <code>GetThreadContext</code> function takes two arguments. The first is a thread handle and it has to be opened with the <code>THREAD_GET_CONTEXT</code> flag. Later we&rsquo;ll also want to use <code>SetThreadContext</code>, which will require the <code>THREAD_SET_CONTEXT</code> flag, so we&rsquo;ll use both when we open the thread handle. We can use the thread ID we got from the <code>WaitForDebugEventEx</code>. Thread IDs are unique across the entire system, so no process ID is needed here.
I&rsquo;ve also made a little utility container called <code>AutoClosedHandle</code> to make sure that <code>CloseHandle</code> gets called on the handle when it gets dropped.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">137</span><span>        <span style=color:#66d9ef>let</span> thread <span style=color:#f92672>=</span> AutoClosedHandle(<span style=color:#66d9ef>unsafe</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">138</span><span>            OpenThread(
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">139</span><span>                <span style=color:#66d9ef>THREAD_GET_CONTEXT</span> <span style=color:#f92672>|</span> <span style=color:#66d9ef>THREAD_SET_CONTEXT</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">140</span><span>                <span style=color:#66d9ef>FALSE</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">141</span><span>                debug_event.dwThreadId,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">142</span><span>            )
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">143</span><span>        });
</span></span></code></pre></div><p><small><a href=https://github.com/TimMisiak/dbgrs/blob/part2/src/main.rs>main.rs</a></small></p><p>The second argument to <code>GetThreadContext</code> is the win32 <code>CONTEXT</code> structure. This is a bit of an odd structure on Windows, because it&rsquo;s specific to a CPU architecture, and the version you get is determined at compile time by the architecture of the debugger process, not the target process. As you might imagine, this can make cross-architecture debugging somewhat complicated. We&rsquo;ll leave that problem for another day and just assume that this is an x64 debugger process debugging an x64 target process. The definition of <code>CONTEXT</code> also has some alignment requirements, which are unfortunately not automatically annotated by the windows-sys crate right now. The folks on the windows-rs project <a href=https://github.com/microsoft/windows-rs/issues/2347>are aware of the issue</a>, but for now we can work around this by wrapping the structure inside another structure that has proper alignment.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span><span style=color:#75715e>#[repr(align(16))]</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span><span style=color:#66d9ef>struct</span> <span style=color:#a6e22e>AlignedContext</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>    context: <span style=color:#a6e22e>CONTEXT</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>}
</span></span></code></pre></div><p><small><a href=https://github.com/TimMisiak/dbgrs/blob/part2/src/main.rs>main.rs</a></small></p><p>Also, because the context parameter to <code>GetThreadContext</code> is an in/out parameter, we need to make sure it&rsquo;s properly initialized, including the <code>ContextFlags</code> field which determines which flags should be queried (and which are valid when we call <code>SetThreadContext</code>). With that, we can finally call <code>GetThreadContext</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">144</span><span>        <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> ctx: <span style=color:#a6e22e>AlignedContext</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>unsafe</span> { std::mem::zeroed() };
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">145</span><span>        ctx.context.ContextFlags <span style=color:#f92672>=</span> <span style=color:#66d9ef>CONTEXT_ALL</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">146</span><span>        <span style=color:#66d9ef>let</span> ret <span style=color:#f92672>=</span> <span style=color:#66d9ef>unsafe</span> { GetThreadContext(thread.handle(), <span style=color:#f92672>&amp;</span><span style=color:#66d9ef>mut</span> ctx.context) };
</span></span></code></pre></div><p><small><a href=https://github.com/TimMisiak/dbgrs/blob/part2/src/main.rs>main.rs</a></small></p><h1 id=handling-commands>Handling commands</h1><p>Using the register context, we can display a summary of the current state and a prompt for the user to enter commands. Since we don&rsquo;t have any kind of symbol resolution yet, we&rsquo;ll have to settle for displaying the current thread ID and the current instruction pointer.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">152</span><span>        <span style=color:#66d9ef>let</span> <span style=color:#66d9ef>mut</span> continue_execution <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">153</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">154</span><span>        <span style=color:#66d9ef>while</span> <span style=color:#f92672>!</span>continue_execution {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">155</span><span>            println!(<span style=color:#e6db74>&#34;[</span><span style=color:#e6db74>{:X}</span><span style=color:#e6db74>] </span><span style=color:#e6db74>{:#018x}</span><span style=color:#e6db74>&#34;</span>, debug_event.dwThreadId, ctx.context.Rip);
</span></span></code></pre></div><p><small><a href=https://github.com/TimMisiak/dbgrs/blob/part2/src/main.rs>main.rs</a></small></p><p>Next we&rsquo;ll read a command from the prompt and have handlers for each of the commands. We&rsquo;ll start with <code>Expr::DisplayRegisters</code>, which has a straightforward implementation:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">159</span><span>            <span style=color:#66d9ef>let</span> cmd <span style=color:#f92672>=</span> command::read_command();
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">160</span><span>            <span style=color:#66d9ef>match</span> cmd {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">161</span><span>                Expr::DisplayRegisters(_) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">162</span><span>                    registers::display_all(ctx.context);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">163</span><span>                }
</span></span></code></pre></div><p><small><a href=https://github.com/TimMisiak/dbgrs/blob/part2/src/main.rs>main.rs</a></small></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#66d9ef>pub</span> <span style=color:#66d9ef>fn</span> <span style=color:#a6e22e>display_all</span>(context: <span style=color:#a6e22e>CONTEXT</span>) {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>    println!(<span style=color:#e6db74>&#34;rax=</span><span style=color:#e6db74>{:#018x}</span><span style=color:#e6db74> rbx=</span><span style=color:#e6db74>{:#018x}</span><span style=color:#e6db74> rcx=</span><span style=color:#e6db74>{:#018x}</span><span style=color:#e6db74>&#34;</span>, context.Rax, context.Rbx, context.Rcx);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span>    println!(<span style=color:#e6db74>&#34;rdx=</span><span style=color:#e6db74>{:#018x}</span><span style=color:#e6db74> rsi=</span><span style=color:#e6db74>{:#018x}</span><span style=color:#e6db74> rdi=</span><span style=color:#e6db74>{:#018x}</span><span style=color:#e6db74>&#34;</span>, context.Rdx, context.Rsi, context.Rdi);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>    println!(<span style=color:#e6db74>&#34;rip=</span><span style=color:#e6db74>{:#018x}</span><span style=color:#e6db74> rsp=</span><span style=color:#e6db74>{:#018x}</span><span style=color:#e6db74> rbp=</span><span style=color:#e6db74>{:#018x}</span><span style=color:#e6db74>&#34;</span>, context.Rip, context.Rsp, context.Rbp);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    println!(<span style=color:#e6db74>&#34; r8=</span><span style=color:#e6db74>{:#018x}</span><span style=color:#e6db74>  r9=</span><span style=color:#e6db74>{:#018x}</span><span style=color:#e6db74> r10=</span><span style=color:#e6db74>{:#018x}</span><span style=color:#e6db74>&#34;</span>, context.R8, context.R9, context.R10);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    println!(<span style=color:#e6db74>&#34;r11=</span><span style=color:#e6db74>{:#018x}</span><span style=color:#e6db74> r12=</span><span style=color:#e6db74>{:#018x}</span><span style=color:#e6db74> r13=</span><span style=color:#e6db74>{:#018x}</span><span style=color:#e6db74>&#34;</span>, context.R11, context.R12, context.R13);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    println!(<span style=color:#e6db74>&#34;r14=</span><span style=color:#e6db74>{:#018x}</span><span style=color:#e6db74> r15=</span><span style=color:#e6db74>{:#018x}</span><span style=color:#e6db74> eflags=</span><span style=color:#e6db74>{:#010x}</span><span style=color:#e6db74>&#34;</span>, context.R14, context.R15, context.EFlags);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>}
</span></span></code></pre></div><p><small><a href=https://github.com/TimMisiak/dbgrs/blob/part2/src/registers.rs>registers.rs</a></small></p><p>The <code>Expr::Go</code> and <code>Expr::Quit</code> commands are also straightforward:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">169</span><span>                Expr::Go(_) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">170</span><span>                    <span style=color:#75715e>// We&#39;ll break out of the loop and call ContinueDebugEvent
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">171</span><span><span style=color:#75715e></span>                    continue_execution <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">172</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">173</span><span>                Expr::Quit(_) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">174</span><span>                    <span style=color:#75715e>// The process will be terminated since we didn&#39;t detach.
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">175</span><span><span style=color:#75715e></span>                    <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">176</span><span>                }
</span></span></code></pre></div><h2 id=step-command>Step command</h2><p>The simplest type of step command is the &ldquo;step into&rdquo; command. We don&rsquo;t have any source line information, so this will specifically be an instruction-level step into, which simply means that we will ask the thread to execute a single instruction. Luckily, most CPUs have a mechanism for this, and on x86 this is called the &ldquo;trap flag&rdquo; or TF for short. We&rsquo;ll take the context that we just read from the thread, add the trap flag to the EFLAGS register, and then set the context on the current thread.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">160</span><span>                Expr::StepInto(_) <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">161</span><span>                    ctx.context.EFlags <span style=color:#f92672>|=</span> <span style=color:#66d9ef>TRAP_FLAG</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">162</span><span>                    <span style=color:#66d9ef>let</span> ret <span style=color:#f92672>=</span> <span style=color:#66d9ef>unsafe</span> { SetThreadContext(thread.handle(), <span style=color:#f92672>&amp;</span>ctx.context) };
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">163</span><span>                    <span style=color:#66d9ef>if</span> ret <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">164</span><span>                        panic!(<span style=color:#e6db74>&#34;SetThreadContext failed&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">165</span><span>                    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">166</span><span>                    expect_step_exception <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">167</span><span>                    continue_execution <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">168</span><span>                }
</span></span></code></pre></div><p><small><a href=https://github.com/TimMisiak/dbgrs/blob/part2/src/main.rs>main.rs</a></small></p><p>When execution is resumed on the thread, it will allow a single instruction to execute before it causes a &ldquo;trap&rdquo;, which is represented as an exception debug event. But there&rsquo;s a small twist here, because if you try to use the step command with what we&rsquo;ve written so far, it will look like the step command worked but the process will exit unexpectedly instead of letting you continue to step. This is because the trap flag has created an unhandled exception that the program was not designed to handle, which results in the process terminating. Luckily the ContinueDebugEvent takes a parameter of <code>dwContinueStatus</code> where passing <code>DBG_CONTINUE</code> tells the kernel to mark the exception as &ldquo;handled&rdquo; and causes the execution to continue normally at the location of the current thread context. We need to pass that value only when we know the exception was caused by a step command, or else we will end up suppressing real exceptions.</p><p>We could simply assume that any exception with code 0x80000004 (<a href=https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-exception_record>EXCEPTION_SINGLE_STEP</a>) was one that was generated by the debugger, and I&rsquo;m sure some debuggers do that. However, single step exceptions can happen normally in a program without a debugger attached (either intentionally or due to program error), and are occasionally used as a form of anti-debugging. If we&rsquo;re not careful, we could change the program behavior unintentionally while debugging it. To keep things simple, we&rsquo;ll just assume that the next exception with code EXCEPTION_SINGLE_STEP <em>after</em> a step operation is one that was caused by the debugger.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109</span><span>            <span style=color:#66d9ef>EXCEPTION_DEBUG_EVENT</span> <span style=color:#f92672>=&gt;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110</span><span>                <span style=color:#66d9ef>let</span> code <span style=color:#f92672>=</span> <span style=color:#66d9ef>unsafe</span> { debug_event.u.Exception.ExceptionRecord.ExceptionCode };
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111</span><span>                <span style=color:#66d9ef>let</span> first_chance <span style=color:#f92672>=</span> <span style=color:#66d9ef>unsafe</span> { debug_event.u.Exception.dwFirstChance };
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112</span><span>                <span style=color:#66d9ef>let</span> chance_string <span style=color:#f92672>=</span> <span style=color:#66d9ef>if</span> first_chance <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113</span><span>                    <span style=color:#e6db74>&#34;second chance&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114</span><span>                } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115</span><span>                    <span style=color:#e6db74>&#34;first chance&#34;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116</span><span>                };
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118</span><span>                <span style=color:#66d9ef>if</span> expect_step_exception <span style=color:#f92672>&amp;&amp;</span> code <span style=color:#f92672>==</span> <span style=color:#66d9ef>EXCEPTION_SINGLE_STEP</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119</span><span>                    expect_step_exception <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">120</span><span>                    continue_status <span style=color:#f92672>=</span> <span style=color:#66d9ef>DBG_CONTINUE</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">121</span><span>                } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">122</span><span>                    println!(<span style=color:#e6db74>&#34;Exception code </span><span style=color:#e6db74>{:x}</span><span style=color:#e6db74> (</span><span style=color:#e6db74>{}</span><span style=color:#e6db74>)&#34;</span>, code, chance_string);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">123</span><span>                    continue_status <span style=color:#f92672>=</span> <span style=color:#66d9ef>DBG_EXCEPTION_NOT_HANDLED</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">124</span><span>                }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">125</span><span>            }
</span></span></code></pre></div><p><small><a href=https://github.com/TimMisiak/dbgrs/blob/part2/src/main.rs>main.rs</a></small></p><h1 id=trying-it-out>Trying it out</h1><p>Let&rsquo;s run the debugger and see how it looks:</p><pre tabindex=0><code>Command line was: &#39;cmd.exe /k &#34;echo hello&#34; &#39;
CreateProcess
[24EC] 0x00007ff812d42680
&gt; g
LoadDll
[24EC] 0x00007ff812d42680
&gt; g
LoadDll
[24EC] 0x00007ff812d8d5c4
&gt; g
LoadDll
[24EC] 0x00007ff812d8d5c4
&gt; t
[24EC] 0x00007ff812d8d5c4
&gt; t
[24EC] 0x00007ff812d04d42
&gt; t
[24EC] 0x00007ff812d04d44
&gt; r
rax=0x0000000000000000 rbx=0x0000000000000000 rcx=0x00007ff812d8d5c4
rdx=0x0000000000000000 rsi=0x000001ee3e0647c0 rdi=0x000001ee3e064680
rip=0x00007ff812d04d44 rsp=0x00000063ed4fe750 rbp=0x00000063ed4fe7d0
 r8=0x00000063ed4fe748  r9=0x00000063ed4fe7d0 r10=0x0000000000000000
r11=0x0000000000000344 r12=0xffffffffffffffff r13=0x00000063ed2b0000
r14=0x000001ee3e064700 r15=0x0000000000800000 eflags=0x00000246
[24EC] 0x00007ff812d04d44
&gt; t
[24EC] 0x00007ff812d04d48
&gt; r
rax=0x0000000000000000 rbx=0x0000000000000000 rcx=0x00007ff812d8d5c4
rdx=0x0000000000000000 rsi=0x000001ee3e0647c0 rdi=0x000001ee3e064680
rip=0x00007ff812d04d48 rsp=0x00000063ed4fe750 rbp=0x00000063ed4fe7d0
 r8=0x00000063ed4fe748  r9=0x00000063ed4fe7d0 r10=0x0000000000000000
r11=0x0000000000000344 r12=0xffffffffffffffff r13=0x00000063ed2b0000
r14=0x000001ee3e064700 r15=0x0000000000800000 eflags=0x00000246
[24EC] 0x00007ff812d04d48
&gt; q
</code></pre><p>What we have now is something incredibly close to what we could really call &ldquo;a debugger&rdquo;. You can continue execution, you can step through code, and you can examine the registers. There are a few really big things missing that prevent this from actually being useful, and most of them have to do with the memory of the target process. This debugger can&rsquo;t read or write from the targets memory, and that means it can&rsquo;t do a number of other important things like resolving symbolic names or displaying disassembly. We&rsquo;ll start to tackle that in the next part. Until then, let me know what you thought of this on <a href=https://twitter.com/timmisiak>Twitter</a> or <a href=https://dbg.social/@tim>Mastodon</a>!</p></div><div class=post-footer></div></article></main></body></html>